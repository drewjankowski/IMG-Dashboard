<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Performance Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #003da5 0%, #002d7a 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.3em;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }
        
        .header .subtitle {
            font-size: 1.3em;
            font-weight: 600;
            opacity: 0.95;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.85;
            font-weight: 400;
        }
        
        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .player-table-section {
            margin-bottom: 40px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #2d3748;
        }
        
        .view-toggles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .view-btn {
            padding: 10px 20px;
            border: 2px solid #003da5;
            background: white;
            color: #003da5;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .view-btn:hover {
            background: #003da5;
            color: white;
        }
        
        .view-btn.active {
            background: #003da5;
            color: white;
        }
        
        .player-table-container {
            overflow-x: auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .player-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            min-width: 800px;
        }
        
        .player-table th:first-child,
        .player-table td:first-child {
            width: 200px;
            min-width: 200px;
        }
        
        .player-table th {
            background: linear-gradient(135deg, #003da5 0%, #002d7a 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .player-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }
        
        .player-table tr:last-child td {
            border-bottom: none;
        }
        
        .player-table tr:hover {
            background: #f7fafc;
        }
        
        .player-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #003da5;
        }
        
        .player-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .player-name {
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .player-name:hover {
            color: #0055d4;
            text-decoration: underline;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #003da5 0%, #002d7a 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-card .player-photo-small {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            margin-bottom: 15px;
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
        }
        
        .stat-card .label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .chart-container {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #003da5;
            font-size: 1.2em;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #003da5;
            background: white;
            color: #003da5;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #003da5;
            color: white;
        }
        
        .filter-btn.active {
            background: #003da5;
            color: white;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #003da5;
        }
        
        .modal-player-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .modal-player-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #003da5;
        }
        
        .modal-player-name {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
        }
        
        .close-btn {
            background: #003da5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #002d7a;
            transform: scale(1.05);
        }
        
        .game-log-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .game-log-table th {
            background: linear-gradient(135deg, #003da5 0%, #002d7a 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .game-log-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85em;
            text-align: center;
        }
        
        .game-log-table tr:last-child td {
            border-bottom: none;
        }
        
        .game-log-table tr:hover {
            background: #f7fafc;
        }
        
        .game-number {
            font-weight: 600;
            color: #003da5;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        
        .trend-up {
            background: #d4edda;
            color: #155724;
        }
        
        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }
        
        .trend-neutral {
            background: #fff3cd;
            color: #856404;
        }
        
        .recent-stats {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ Shannon's Player Performance Dashboard</h1>
            <div class="subtitle">Ex-IMG Lady Basketball Athletes</div>
            <p>College Performance Analytics & Season Tracking</p>
        </div>
        
        <div class="dashboard">
            <div id="loading" class="loading">Loading data from Google Sheets...</div>
            <div id="error" style="display:none;"></div>
            <div id="content" style="display:none;">
                
                <!-- Player Summary Table -->
                <div class="player-table-section">
                    <div class="table-header">
                        <div class="table-title">Player Statistics</div>
                        <div class="view-toggles">
                            <button class="view-btn active" data-view="totals">Totals</button>
                            <button class="view-btn" data-view="per40">Per 40</button>
                        </div>
                    </div>
                    <div class="player-table-container">
                        <table class="player-table" id="playerTable">
                            <!-- Table will be populated by JavaScript -->
                        </table>
                    </div>
                </div>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="player-table-section">
                    <div class="table-header">
                        <div class="table-title">Recent Form - Last 5 Games</div>
                    </div>
                    <div class="player-table-container">
                        <table class="player-table" id="recentFormTable">
                            <!-- Recent form table will be populated by JavaScript -->
                        </table>
                    </div>
                </div>
                
                <div class="filters" id="filters">
                    <button class="filter-btn active" data-filter="all">All Players</button>
                    <button class="filter-btn" data-filter="valid">Valid Minutes Only (5+)</button>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Efficiency vs Playing Time</div>
                    <div id="scatterPlot"></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Player Performance Comparison</div>
                    <div id="barChart"></div>
                </div>
                
                <div class="chart-container">
                    <div class="table-header">
                        <div class="chart-title">Season Progression</div>
                        <div class="view-toggles">
                            <button class="view-btn active" data-stat="points">Points</button>
                            <button class="view-btn" data-stat="rebounds">Rebounds</button>
                            <button class="view-btn" data-stat="assists">Assists</button>
                        </div>
                    </div>
                    <div id="lineChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Player Game Log Modal -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-player-info">
                    <img id="modalPlayerPhoto" class="modal-player-photo" src="" alt="">
                    <div>
                        <div class="modal-player-name" id="modalPlayerName"></div>
                    </div>
                </div>
                <button class="close-btn" onclick="closePlayerModal()">‚Üê Back to Dashboard</button>
            </div>
            <div class="player-table-container">
                <table class="game-log-table" id="gameLogTable">
                    <!-- Game log will be populated by JavaScript -->
                </table>
            </div>
        </div>
    </div>

    <script>
        const GAMELOG_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://docs.google.com/spreadsheets/d/e/2PACX-1vQnGUktmAi7tjoSwbwmq24s6Dp-nMHFmlNh2WpI0Pi6TqWCmmqinhXzH7zKjuxcXXp3LLy3ubYIi6zJ/pub?gid=709035437&single=true&output=csv');
        const AVERAGES_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://docs.google.com/spreadsheets/d/e/2PACX-1vQnGUktmAi7tjoSwbwmq24s6Dp-nMHFmlNh2WpI0Pi6TqWCmmqinhXzH7zKjuxcXXp3LLy3ubYIi6zJ/pub?gid=0&single=true&output=csv');
        
        // Player photos mapping
        const playerPhotos = {
            'Azariah': 'https://i.imgur.com/pg0f1Ay.jpg',
            'Brooklynn Charlo': 'https://i.imgur.com/ZCbGAzk.jpg',
            'Deniya Prawl': 'https://i.imgur.com/ebXQrun.jpg',
            'Kelis Fisher': 'https://i.imgur.com/CLLNFtL.jpg',
            'Lara Somfai': 'https://i.imgur.com/ytUXHO2.jpg',
            'Madison Newbaur': 'https://i.imgur.com/gVi1dSC.jpg',
            'Maddie Newbaur': 'https://i.imgur.com/gVi1dSC.jpg',
            'Manuella Alves': 'https://i.imgur.com/AklXXza.jpg',
            'Nylah Wilson': 'https://i.imgur.com/Q7r2ck7.jpg'
        };
        
        let allData = [];
        let averagesData = [];
        let currentFilter = 'all';
        let currentView = 'totals';
        let currentProgressionStat = 'points';
        
        async function loadData() {
            try {
                // Load game log data
                Papa.parse(GAMELOG_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data.map(row => ({
                            player: row.Player,
                            team: row.Team,
                            opp: row.Opp,
                            mp: parseFloat(row.MP) || 0,
                            pts: parseFloat(row.PTS) || 0,
                            orb: parseFloat(row.ORB) || 0,
                            drb: parseFloat(row.DRB) || 0,
                            ast: parseFloat(row.AST) || 0,
                            stl: parseFloat(row.STL) || 0,
                            tov: parseFloat(row.TOV) || 0,
                            fg: parseFloat(row.FG) || 0,
                            fga: parseFloat(row.FGA) || 0,
                            fgPct: parseFloat(row['FG%']) || 0,
                            trbs: parseFloat(row.TRBS) || 0,
                            pts40: parseFloat(row['PTS per 40']) || 0,
                            reb40: parseFloat(row['REBS per 40']) || 0,
                            ast40: parseFloat(row['AST per 40']) || 0,
                            stl40: parseFloat(row['STL per 40']) || 0,
                            tov40: parseFloat(row['TO per 40']) || 0,
                            ptsPerFGA: parseFloat(row['Points per FG']) || 0,
                            gameScore: parseFloat(row.GameScore) || 0,
                            minThreshold: row['Min Threshold Indicator']
                        })).filter(row => row.player && row.player.trim() !== '');
                        
                        // Load averages data
                        loadAverages();
                    },
                    error: function(error) {
                        showError('Error loading game log data: ' + error.message);
                    }
                });
            } catch (error) {
                showError('Error loading data');
            }
        }
        
        function loadAverages() {
            Papa.parse(AVERAGES_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('Raw averages data:', results.data);
                    console.log('First row columns:', results.data[0] ? Object.keys(results.data[0]) : 'No data');
                    console.log('First row data:', results.data[0]);
                    
                    averagesData = results.data;
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    
                    renderDashboard();
                },
                error: function(error) {
                    showError('Error loading averages data: ' + error.message);
                }
            });
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = '<div class="error">' + message + '</div>';
            document.getElementById('error').style.display = 'block';
        }
        
        function getFilteredData() {
            if (currentFilter === 'valid') {
                return allData.filter(d => d.minThreshold === 'Yes');
            }
            return allData;
        }
        
        function calculatePlayerStats(data) {
            const playerMap = {};
            
            data.forEach(game => {
                if (!playerMap[game.player]) {
                    playerMap[game.player] = {
                        games: [],
                        name: game.player
                    };
                }
                playerMap[game.player].games.push(game);
            });
            
            return Object.values(playerMap).map(player => {
                const games = player.games;
                const validGames = games.filter(g => g.mp >= 5);
                const gp = validGames.length;
                
                if (gp === 0) return null;
                
                const avgMp = validGames.reduce((sum, g) => sum + g.mp, 0) / gp;
                const avgPts = validGames.reduce((sum, g) => sum + g.pts, 0) / gp;
                const avgReb = validGames.reduce((sum, g) => sum + g.trbs, 0) / gp;
                const avgAst = validGames.reduce((sum, g) => sum + g.ast, 0) / gp;
                const avgGameScore = validGames.reduce((sum, g) => sum + g.gameScore, 0) / gp;
                const avgPtsPerFGA = validGames.reduce((sum, g) => sum + g.ptsPerFGA, 0) / gp;
                
                return {
                    name: player.name,
                    gp,
                    avgMp: Math.round(avgMp * 10) / 10,
                    avgPts: Math.round(avgPts * 10) / 10,
                    avgReb: Math.round(avgReb * 10) / 10,
                    avgAst: Math.round(avgAst * 10) / 10,
                    avgGameScore: Math.round(avgGameScore * 10) / 10,
                    avgPtsPerFGA: Math.round(avgPtsPerFGA * 100) / 100,
                    games: validGames
                };
            }).filter(p => p !== null);
        }
        
        function renderPlayerTable() {
            const table = document.getElementById('playerTable');
            
            if (currentView === 'totals') {
                renderTotalsTable(table);
            } else if (currentView === 'per40') {
                renderPer40Table(table);
            }
        }
        
        function renderPerGameTable(table) {
            const headers = ['Player', 'GP', 'MP', 'PTS', 'ORB', 'DRB', 'AST', 'STL', 'TOV', 'FG%', 'FG', 'FGA'];
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            averagesData.forEach(player => {
                // Skip if no player name
                if (!player.Player || player.Player.trim() === '') return;
                
                html += '<tr>';
                html += `<td class="player-name">${player.Player}</td>`;
                html += `<td>${player.GP || 'N/A'}</td>`;
                html += `<td>${player.MP ? parseFloat(player.MP).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.PTS ? parseFloat(player.PTS).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.ORB ? parseFloat(player.ORB).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.DRB ? parseFloat(player.DRB).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.AST ? parseFloat(player.AST).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.STL ? parseFloat(player.STL).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.TOV ? parseFloat(player.TOV).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player['FG%'] ? (parseFloat(player['FG%']) * 100).toFixed(1) + '%' : 'N/A'}</td>`;
                html += `<td>${player.FG ? parseFloat(player.FG).toFixed(1) : 'N/A'}</td>`;
                html += `<td>${player.FGA ? parseFloat(player.FGA).toFixed(1) : 'N/A'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function renderTotalsTable(table) {
            const headers = ['Player', 'GP', 'MP', 'PTS', 'ORB', 'DRB', 'AST', 'STL', 'TOV', 'FG%', 'FG', 'FGA'];
            const filteredData = getFilteredData();
            
            // Calculate totals per player
            const playerTotals = {};
            filteredData.forEach(game => {
                if (!playerTotals[game.player]) {
                    playerTotals[game.player] = {
                        gp: 0, mp: 0, pts: 0, orb: 0, drb: 0, ast: 0, 
                        stl: 0, tov: 0, fg: 0, fga: 0, fgPct: []
                    };
                }
                if (game.mp >= 5) {
                    playerTotals[game.player].gp++;
                    playerTotals[game.player].mp += game.mp;
                    playerTotals[game.player].pts += game.pts;
                    playerTotals[game.player].orb += game.orb;
                    playerTotals[game.player].drb += game.drb;
                    playerTotals[game.player].ast += game.ast;
                    playerTotals[game.player].stl += game.stl;
                    playerTotals[game.player].tov += game.tov;
                    playerTotals[game.player].fg += game.fg;
                    playerTotals[game.player].fga += game.fga;
                    if (game.fgPct > 0) playerTotals[game.player].fgPct.push(game.fgPct);
                }
            });
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            Object.keys(playerTotals).forEach(playerName => {
                const p = playerTotals[playerName];
                const avgFgPct = p.fgPct.length > 0 ? p.fgPct.reduce((a, b) => a + b, 0) / p.fgPct.length : 0;
                const photoUrl = playerPhotos[playerName];
                
                html += '<tr>';
                html += `<td><div class="player-cell">`;
                if (photoUrl) {
                    html += `<img src="${photoUrl}" alt="${playerName}" class="player-photo">`;
                }
                html += `<span class="player-name" onclick="showPlayerGameLog('${playerName}')">${playerName}</span></div></td>`;
                html += `<td>${p.gp}</td>`;
                html += `<td>${Math.round(p.mp)}</td>`;
                html += `<td>${Math.round(p.pts)}</td>`;
                html += `<td>${Math.round(p.orb)}</td>`;
                html += `<td>${Math.round(p.drb)}</td>`;
                html += `<td>${Math.round(p.ast)}</td>`;
                html += `<td>${Math.round(p.stl)}</td>`;
                html += `<td>${Math.round(p.tov)}</td>`;
                html += `<td>${avgFgPct > 0 ? (avgFgPct * 100).toFixed(1) + '%' : 'N/A'}</td>`;
                html += `<td>${Math.round(p.fg)}</td>`;
                html += `<td>${Math.round(p.fga)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function renderPer40Table(table) {
            const headers = ['Player', 'GP', 'PTS', 'REB', 'AST', 'STL', 'TOV'];
            const filteredData = getFilteredData();
            
            // Calculate per 40 averages per player
            const playerPer40 = {};
            filteredData.forEach(game => {
                if (!playerPer40[game.player]) {
                    playerPer40[game.player] = {
                        gp: 0, pts40: [], reb40: [], ast40: [], stl40: [], tov40: []
                    };
                }
                if (game.mp >= 5) {
                    playerPer40[game.player].gp++;
                    if (game.pts40 > 0) playerPer40[game.player].pts40.push(game.pts40);
                    if (game.reb40 > 0) playerPer40[game.player].reb40.push(game.reb40);
                    if (game.ast40 > 0) playerPer40[game.player].ast40.push(game.ast40);
                    if (game.stl40 > 0) playerPer40[game.player].stl40.push(game.stl40);
                    if (game.tov40 > 0) playerPer40[game.player].tov40.push(game.tov40);
                }
            });
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            Object.keys(playerPer40).forEach(playerName => {
                const p = playerPer40[playerName];
                const avg = (arr) => arr.length > 0 ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1) : 'N/A';
                const photoUrl = playerPhotos[playerName];
                
                html += '<tr>';
                html += `<td><div class="player-cell">`;
                if (photoUrl) {
                    html += `<img src="${photoUrl}" alt="${playerName}" class="player-photo">`;
                }
                html += `<span class="player-name" onclick="showPlayerGameLog('${playerName}')">${playerName}</span></div></td>`;
                html += `<td>${p.gp}</td>`;
                html += `<td>${avg(p.pts40)}</td>`;
                html += `<td>${avg(p.reb40)}</td>`;
                html += `<td>${avg(p.ast40)}</td>`;
                html += `<td>${avg(p.stl40)}</td>`;
                html += `<td>${avg(p.tov40)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function renderDashboard() {
            const filteredData = getFilteredData();
            const playerStats = calculatePlayerStats(filteredData);
            
            renderPlayerTable();
            renderStatsCards(playerStats);
            renderRecentFormTable(filteredData);
            renderScatterPlot(playerStats);
            renderBarChart(playerStats);
            renderLineChart(filteredData);
        }
        
        function renderStatsCards(playerStats) {
            const topScorer = playerStats.reduce((max, p) => p.avgPts > max.avgPts ? p : max, playerStats[0]);
            const mostEfficient = playerStats.reduce((max, p) => p.avgPtsPerFGA > max.avgPtsPerFGA ? p : max, playerStats[0]);
            const mostMinutes = playerStats.reduce((max, p) => p.avgMp > max.avgMp ? p : max, playerStats[0]);
            const topImpact = playerStats.reduce((max, p) => p.avgGameScore > max.avgGameScore ? p : max, playerStats[0]);
            
            const getPhotoHtml = (playerName) => {
                const photoUrl = playerPhotos[playerName];
                return photoUrl ? `<img src="${photoUrl}" alt="${playerName}" class="player-photo-small">` : '';
            };
            
            const html = `
                <div class="stat-card">
                    ${getPhotoHtml(topScorer.name)}
                    <h3>Top Scorer</h3>
                    <div class="value">${topScorer.avgPts}</div>
                    <div class="label">${topScorer.name}</div>
                </div>
                <div class="stat-card">
                    ${getPhotoHtml(mostEfficient.name)}
                    <h3>Most Efficient</h3>
                    <div class="value">${mostEfficient.avgPtsPerFGA}</div>
                    <div class="label">${mostEfficient.name}</div>
                </div>
                <div class="stat-card">
                    ${getPhotoHtml(mostMinutes.name)}
                    <h3>Most Minutes</h3>
                    <div class="value">${mostMinutes.avgMp}</div>
                    <div class="label">${mostMinutes.name}</div>
                </div>
                <div class="stat-card">
                    ${getPhotoHtml(topImpact.name)}
                    <h3>Top Impact</h3>
                    <div class="value">${topImpact.avgGameScore}</div>
                    <div class="label">${topImpact.name}</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = html;
        }
        
        function renderRecentFormTable(data) {
            const table = document.getElementById('recentFormTable');
            const playerMap = {};
            
            // Group games by player
            data.forEach(game => {
                if (!playerMap[game.player]) {
                    playerMap[game.player] = [];
                }
                if (game.mp >= 5) {
                    playerMap[game.player].push(game);
                }
            });
            
            const headers = ['Player', 'Last 5 PPG', 'Season PPG', 'Trend', 'Last 5 RPG', 'Season RPG', 'Trend', 'Last 5 APG', 'Season APG', 'Trend'];
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            Object.keys(playerMap).forEach(playerName => {
                const games = playerMap[playerName];
                
                // Only show if player has at least 5 games
                if (games.length < 5) return;
                
                // Get last 5 games
                const last5 = games.slice(-5);
                
                // Calculate season averages
                const seasonPPG = (games.reduce((sum, g) => sum + g.pts, 0) / games.length).toFixed(1);
                const seasonRPG = (games.reduce((sum, g) => sum + g.trbs, 0) / games.length).toFixed(1);
                const seasonAPG = (games.reduce((sum, g) => sum + g.ast, 0) / games.length).toFixed(1);
                
                // Calculate last 5 averages
                const last5PPG = (last5.reduce((sum, g) => sum + g.pts, 0) / 5).toFixed(1);
                const last5RPG = (last5.reduce((sum, g) => sum + g.trbs, 0) / 5).toFixed(1);
                const last5APG = (last5.reduce((sum, g) => sum + g.ast, 0) / 5).toFixed(1);
                
                // Calculate trends (comparing last 5 to season average)
                const getTrend = (recent, season) => {
                    const diff = ((recent - season) / season) * 100;
                    if (diff > 10) return { class: 'trend-up', text: '‚Üë Hot', icon: 'üî•' };
                    if (diff < -10) return { class: 'trend-down', text: '‚Üì Cold', icon: '‚ùÑÔ∏è' };
                    return { class: 'trend-neutral', text: '‚Üí Steady', icon: '‚û°Ô∏è' };
                };
                
                const ptsTrend = getTrend(parseFloat(last5PPG), parseFloat(seasonPPG));
                const rebTrend = getTrend(parseFloat(last5RPG), parseFloat(seasonRPG));
                const astTrend = getTrend(parseFloat(last5APG), parseFloat(seasonAPG));
                
                const photoUrl = playerPhotos[playerName];
                
                html += '<tr>';
                html += `<td><div class="player-cell">`;
                if (photoUrl) {
                    html += `<img src="${photoUrl}" alt="${playerName}" class="player-photo">`;
                }
                html += `<span class="player-name" onclick="showPlayerGameLog('${playerName}')">${playerName}</span></div></td>`;
                html += `<td>${last5PPG}</td>`;
                html += `<td>${seasonPPG}</td>`;
                html += `<td><span class="trend-indicator ${ptsTrend.class}">${ptsTrend.icon} ${ptsTrend.text}</span></td>`;
                html += `<td>${last5RPG}</td>`;
                html += `<td>${seasonRPG}</td>`;
                html += `<td><span class="trend-indicator ${rebTrend.class}">${rebTrend.icon} ${rebTrend.text}</span></td>`;
                html += `<td>${last5APG}</td>`;
                html += `<td>${seasonAPG}</td>`;
                html += `<td><span class="trend-indicator ${astTrend.class}">${astTrend.icon} ${astTrend.text}</span></td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function renderScatterPlot(playerStats) {
            const trace = {
                x: playerStats.map(p => p.avgMp),
                y: playerStats.map(p => p.avgPtsPerFGA),
                text: playerStats.map(p => p.name),
                mode: 'markers+text',
                type: 'scatter',
                marker: {
                    size: playerStats.map(p => Math.max(10, p.avgGameScore * 2)),
                    color: playerStats.map(p => p.avgGameScore),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'GameScore'
                    },
                    line: {
                        color: 'white',
                        width: 2
                    }
                },
                textposition: 'top center',
                textfont: {
                    size: 11,
                    color: '#2d3748'
                },
                hovertemplate: '<b>%{text}</b><br>' +
                              'Minutes: %{x:.1f}<br>' +
                              'PTS/FGA: %{y:.2f}<br>' +
                              '<extra></extra>'
            };
            
            const layout = {
                xaxis: {
                    title: 'Average Minutes Per Game',
                    gridcolor: '#e2e8f0',
                    zeroline: true
                },
                yaxis: {
                    title: 'Points Per Field Goal Attempt',
                    gridcolor: '#e2e8f0',
                    zeroline: true
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                hovermode: 'closest',
                margin: { t: 20, r: 20, b: 60, l: 60 },
                height: 500
            };
            
            Plotly.newPlot('scatterPlot', [trace], layout, {responsive: true});
        }
        
        function renderBarChart(playerStats) {
            const sortedPlayers = playerStats.sort((a, b) => b.avgPts - a.avgPts);
            
            const trace1 = {
                x: sortedPlayers.map(p => p.name),
                y: sortedPlayers.map(p => p.avgPts),
                name: 'PPG',
                type: 'bar',
                marker: { color: '#003da5' }
            };
            
            const trace2 = {
                x: sortedPlayers.map(p => p.name),
                y: sortedPlayers.map(p => p.avgReb),
                name: 'RPG',
                type: 'bar',
                marker: { color: '#0055d4' }
            };
            
            const trace3 = {
                x: sortedPlayers.map(p => p.name),
                y: sortedPlayers.map(p => p.avgAst),
                name: 'APG',
                type: 'bar',
                marker: { color: '#4a90e2' }
            };
            
            const layout = {
                barmode: 'group',
                xaxis: { title: 'Player' },
                yaxis: { title: 'Per Game Average' },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: { t: 20, r: 20, b: 80, l: 60 },
                height: 400,
                legend: { orientation: 'h', y: 1.1 }
            };
            
            Plotly.newPlot('barChart', [trace1, trace2, trace3], layout, {responsive: true});
        }
        
        function renderLineChart(data) {
            const playerMap = {};
            
            data.forEach(game => {
                if (!playerMap[game.player]) {
                    playerMap[game.player] = [];
                }
                if (game.mp >= 5) {
                    playerMap[game.player].push(game);
                }
            });
            
            let yData, yAxisTitle;
            
            if (currentProgressionStat === 'points') {
                yData = (games) => {
                    let cumulative = 0;
                    return games.map(g => {
                        cumulative += g.pts;
                        return cumulative;
                    });
                };
                yAxisTitle = 'Cumulative Points';
            } else if (currentProgressionStat === 'rebounds') {
                yData = (games) => {
                    let cumulative = 0;
                    return games.map(g => {
                        cumulative += g.trbs;
                        return cumulative;
                    });
                };
                yAxisTitle = 'Cumulative Total Rebounds';
            } else if (currentProgressionStat === 'assists') {
                yData = (games) => {
                    let cumulative = 0;
                    return games.map(g => {
                        cumulative += g.ast;
                        return cumulative;
                    });
                };
                yAxisTitle = 'Cumulative Assists';
            }
            
            const traces = Object.keys(playerMap).map(playerName => {
                const games = playerMap[playerName];
                return {
                    x: games.map((g, i) => i + 1),
                    y: yData(games),
                    name: playerName,
                    mode: 'lines+markers',
                    type: 'scatter'
                };
            });
            
            const layout = {
                xaxis: { title: 'Game Number' },
                yaxis: { title: yAxisTitle },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: { t: 20, r: 20, b: 60, l: 60 },
                height: 400,
                hovermode: 'closest'
            };
            
            Plotly.newPlot('lineChart', traces, layout, {responsive: true});
        }
        
        function showPlayerGameLog(playerName) {
            const modal = document.getElementById('playerModal');
            const modalPlayerName = document.getElementById('modalPlayerName');
            const modalPlayerPhoto = document.getElementById('modalPlayerPhoto');
            const gameLogTable = document.getElementById('gameLogTable');
            
            // Set player info
            modalPlayerName.textContent = playerName;
            const photoUrl = playerPhotos[playerName];
            if (photoUrl) {
                modalPlayerPhoto.src = photoUrl;
                modalPlayerPhoto.style.display = 'block';
            } else {
                modalPlayerPhoto.style.display = 'none';
            }
            
            // Get all games for this player
            const playerGames = allData.filter(g => g.player === playerName && g.mp >= 5);
            
            // Build game log table
            const headers = ['Game', 'Opp', 'MP', 'PTS', 'ORB', 'DRB', 'TRB', 'AST', 'STL', 'TOV', 'FG', 'FGA', 'FG%', 'GameScore'];
            
            let html = '<thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            playerGames.forEach((game, index) => {
                html += '<tr>';
                html += `<td class="game-number">${index + 1}</td>`;
                html += `<td>${game.opp || 'N/A'}</td>`;
                html += `<td>${game.mp.toFixed(1)}</td>`;
                html += `<td>${game.pts}</td>`;
                html += `<td>${game.orb}</td>`;
                html += `<td>${game.drb}</td>`;
                html += `<td>${game.trbs}</td>`;
                html += `<td>${game.ast}</td>`;
                html += `<td>${game.stl}</td>`;
                html += `<td>${game.tov}</td>`;
                html += `<td>${game.fg}</td>`;
                html += `<td>${game.fga}</td>`;
                html += `<td>${game.fgPct > 0 ? (game.fgPct * 100).toFixed(1) + '%' : 'N/A'}</td>`;
                html += `<td>${game.gameScore.toFixed(1)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody>';
            gameLogTable.innerHTML = html;
            
            // Show modal
            modal.style.display = 'block';
        }
        
        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('playerModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // View toggle buttons
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Handle table view toggles
                if (btn.dataset.view) {
                    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    renderPlayerTable();
                }
                // Handle progression stat toggles
                if (btn.dataset.stat) {
                    document.querySelectorAll('[data-stat]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentProgressionStat = btn.dataset.stat;
                    renderLineChart(getFilteredData());
                }
            });
        });
        
        // Filter buttons
        document.getElementById('filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderDashboard();
            }
        });
        
        loadData();
    </script>
</body>
</html>